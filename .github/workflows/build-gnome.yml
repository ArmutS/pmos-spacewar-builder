name: Build PostmarketOS (GNOME) for Spacewar

on:
  workflow_dispatch: # Manuel tetikleme

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip git openssl android-sdk-platform-tools-common
          sudo pip3 install git+https://gitlab.postmarketos.org/postmarketOS/pmbootstrap.git --break-system-packages

      - name: Clone Custom Aports (Nothing Phone 1 Branch)
        run: |
          git clone -b nothing-spacewar https://gitlab.postmarketos.org/fekz115/pmaports.git pmaports

      - name: Initialize and Configure
        run: |
          # ADIM 1: Önce varsayılan ayarlarla init yapıp config dosyasını oluşturuyoruz.
          # 'yes ""' komutu, sorulan tüm sorulara (work path vb.) Enter tuşuyla onay verir.
          yes "" | pmbootstrap --aports=$(pwd)/pmaports init
          
          # ADIM 2: Şimdi oluşan config dosyasını Spacewar için güncelliyoruz.
          pmbootstrap config vendor nothing
          pmbootstrap config device spacewar
          pmbootstrap config ui gnome
          pmbootstrap config hostname nothing-pmos
          pmbootstrap config user user
          pmbootstrap config build_pkgs_on_install True
          
          # Kontrol için config durumunu yazdıralım (Loglarda görmek için)
          pmbootstrap config

      - name: Build Rootfs
        run: |
          # Artık config dosyamız doğru olduğu için install komutu Spacewar için çalışacak
          # --zap parametresi eski chroot kalıntılarını temizler (temiz kurulum için)
          pmbootstrap --zap install --no-fde --password=1234

      - name: Export Images
        run: |
          pmbootstrap export

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pmos-spacewar-gnome-images
          path: /tmp/postmarketOS-export/
          retention-days: 5
