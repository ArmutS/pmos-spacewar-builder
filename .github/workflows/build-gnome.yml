name: Build PostmarketOS (Spacewar) - DEBUG & FIX

on:
  workflow_dispatch: # Manuel tetikleme

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip git openssl android-sdk-platform-tools-common
          sudo pip3 install git+https://gitlab.postmarketos.org/postmarketOS/pmbootstrap.git --break-system-packages

      - name: Clone Custom Aports (Nothing Phone 1 Branch)
        run: |
          git clone -b nothing-spacewar https://gitlab.postmarketos.org/fekz115/pmaports.git pmaports
          cd pmaports
          git remote add upstream https://gitlab.postmarketos.org/postmarketOS/pmaports.git
          git fetch upstream
          cd ..

      - name: Initialize pmbootstrap (Dummy)
        run: |
          # Config dosyasÄ±nÄ± oluÅŸturmak iÃ§in boÅŸ init
          yes "" | pmbootstrap --aports=$(pwd)/pmaports init

      - name: ðŸ” DETECT REAL DEVICE NAME (Critical Step)
        run: |
          echo "=== DEBUG: Searching for Spacewar deviceinfo ==="
          
          # Ä°Ã§inde 'codename="spacewar"' geÃ§en deviceinfo dosyasÄ±nÄ± buluyoruz.
          # Bu komut klasÃ¶r yapÄ±sÄ± ne olursa olsun doÄŸru dosyayÄ± bulur.
          DEVICEINFO_PATH=$(grep -l 'deviceinfo_codename="spacewar"' -r pmaports/device)
          
          if [ -z "$DEVICEINFO_PATH" ]; then
             echo "âŒ ERROR: Spacewar codename not found in this repo!"
             echo "List of all available nothing devices:"
             find pmaports/device -name "*nothing*"
             exit 1
          fi
          
          echo "âœ… Found deviceinfo at: $DEVICEINFO_PATH"
          
          # Dosya yolundan klasÃ¶r ismini ayÄ±klÄ±yoruz (Ã¶rn: device-nothing-spacewar)
          DEVICE_DIR_NAME=$(basename $(dirname $DEVICEINFO_PATH))
          echo "ðŸ“‚ Folder Name: $DEVICE_DIR_NAME"
          
          # 'device-' Ã¶nekinin kaldÄ±rÄ±yoruz (pmbootstrap iÃ§in)
          # Ã–rn: device-nothing-spacewar -> nothing-spacewar
          TARGET_DEVICE=${DEVICE_DIR_NAME#device-}
          
          echo "ðŸŽ¯ TARGET DEVICE ID: $TARGET_DEVICE"
          
          # BulduÄŸumuz doÄŸru ismi config'e yazÄ±yoruz
          pmbootstrap config device $TARGET_DEVICE
          pmbootstrap config ui gnome
          pmbootstrap config hostname nothing-pmos
          pmbootstrap config user user
          pmbootstrap config build_pkgs_on_install True
          
          echo "=== Configuration Complete ==="
          pmbootstrap config

      - name: Build Rootfs
        run: |
          echo "ðŸš€ Starting Build for calculated device..."
          pmbootstrap install --no-fde --password=1234

      - name: Export Images
        run: |
          pmbootstrap export

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pmos-spacewar-gnome-images
          path: /tmp/postmarketOS-export/
          retention-days: 5
