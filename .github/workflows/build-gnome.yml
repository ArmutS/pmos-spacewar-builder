name: Build PostmarketOS (GNOME) for Spacewar

on:
  workflow_dispatch: # Manuel tetikleme

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip git openssl android-sdk-platform-tools-common
          sudo pip3 install git+https://gitlab.postmarketos.org/postmarketOS/pmbootstrap.git --break-system-packages

      - name: Clone Custom Aports (Nothing Phone 1 Branch)
        run: |
          git clone -b nothing-spacewar https://gitlab.postmarketos.org/fekz115/pmaports.git pmaports
          
          # Remote hatasını önlemek için upstream ekliyoruz
          cd pmaports
          git remote add upstream https://gitlab.postmarketos.org/postmarketOS/pmaports.git
          git fetch upstream
          cd ..

      - name: Initialize pmbootstrap (Dummy)
        run: |
          # Varsayılan ayarlarla init yapıp config dosyasını oluşturuyoruz
          # Bu aşamada cihaz qemu-amd64 seçilecek, birazdan düzelteceğiz.
          yes "" | pmbootstrap --aports=$(pwd)/pmaports init

      - name: Detect and Configure Device
        run: |
          echo "Looking for Nothing Phone (1) device folder..."
          
          # 'device-nothing-*' ile başlayan klasörü buluyoruz
          DEVICE_PATH=$(find pmaports/device -name "device-nothing-*" -type d | head -n 1)
          
          if [ -z "$DEVICE_PATH" ]; then
            echo "ERROR: Device folder not found!"
            ls -R pmaports/device
            exit 1
          fi
          
          echo "Found device folder at: $DEVICE_PATH"
          
          # deviceinfo dosyasından gerçek kod adını (codename) çekiyoruz
          # Genellikle 'spacewar' veya 'nothing-spacewar' yazar.
          REAL_CODENAME=$(grep "deviceinfo_codename=" "$DEVICE_PATH/deviceinfo" | cut -d'"' -f2)
          
          echo "Detected Real Codename: $REAL_CODENAME"
          
          # Bulduğumuz doğru ismi config'e işliyoruz
          pmbootstrap config device $REAL_CODENAME
          pmbootstrap config ui gnome
          pmbootstrap config hostname nothing-pmos
          pmbootstrap config user user
          pmbootstrap config build_pkgs_on_install True
          
          # Garanti olsun diye index'i güncelliyoruz
          pmbootstrap index

      - name: Build Rootfs
        run: |
          # --no-fde: Şifreleme yok
          pmbootstrap install --no-fde --password=1234

      - name: Export Images
        run: |
          pmbootstrap export

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pmos-spacewar-gnome-images
          path: /tmp/postmarketOS-export/
          retention-days: 5
